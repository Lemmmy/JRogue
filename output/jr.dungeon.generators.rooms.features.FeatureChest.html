<HTML>
<HEAD>
<TITLE>JDocCoverage Report - 14-Mar-2017 09:54:02</TITLE>
<link rel='stylesheet' type='text/css' href='default.css'>
</HEAD>
<BODY>
<TABLE cellspacing='0' class='header'><TR><TD class='title'>JDocCoverage Report - 14-Mar-2017 09:54:02</TD></TR>
<TR><TD class='menu'><a class='menu' href='index.html'>Overview</a> | <a class='menu' href='jr.dungeon.generators.rooms.features.html'>jr.dungeon.generators.rooms.features</a></TD></TR></TABLE>
<p>
<TABLE cellspacing='0'>
<TR><TH>Name</TH><TH>method, %</TH><TH>comment, %</TH><TH>TODO</TH><TH>@see</TH></TR>

<TR><TD>jr.dungeon.generators.rooms.features.FeatureChest</TD><TD>3</TD><TD>1.7% &nbsp; (50/2976)</TD><TD>0</TD><TD>0</TD></TR>
</TABLE>
<CODE><PRE>
<span class='code'>package jr.dungeon.generators.rooms.features;

import com.github.alexeyr.pcg.Pcg32;
import jr.JRogue;
import jr.dungeon.Level;
import jr.dungeon.entities.containers.Container;
import jr.dungeon.entities.containers.EntityChest;
import jr.dungeon.generators.rooms.Room;
import jr.dungeon.items.Item;
import jr.dungeon.items.ItemStack;
import jr.dungeon.items.SpecialChestSpawn;
import jr.dungeon.items.comestibles.*;
import jr.dungeon.items.magical.ItemSpellbook;
import jr.dungeon.items.valuables.ItemGem;
import jr.dungeon.items.valuables.ItemThermometer;
import jr.dungeon.items.weapons.ItemDagger;
import jr.dungeon.items.weapons.ItemLongsword;
import jr.dungeon.items.weapons.ItemShortsword;
import jr.utils.RandomUtils;
import jr.utils.WeightedCollection;
import org.apache.commons.lang3.reflect.ConstructorUtils;

import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

public class FeatureChest extends SpecialRoomFeature {
	private static final WeightedCollection&lt;ItemGroup> ITEM_GROUPS = new WeightedCollection&lt;>();
	
	static {
</span><span class='comment'>		// FOOD
</span><span class='code'>		ITEM_GROUPS.add(30, new ItemGroup(
			ItemApple.class,
			ItemBanana.class,
			ItemBread.class,
			ItemCarrot.class,
			ItemCherries.class,
			ItemCorn.class,
			ItemLemon.class,
			ItemOrange.class
		));
		
</span><span class='comment'>		// WEAPONS
</span><span class='code'>		ITEM_GROUPS.add(6, new ItemGroup(
			ItemDagger.class,
			ItemShortsword.class,
			ItemLongsword.class
		));
		
</span><span class='comment'>		// GEMS
</span><span class='code'>		ITEM_GROUPS.add(4, new ItemGroup(
			ItemGem.class
		));
		
</span><span class='comment'>		// MISC
</span><span class='code'>		ITEM_GROUPS.add(1, new ItemGroup(
			ItemThermometer.class,
			ItemSpellbook.class
		));
	}
	
	private Pcg32 rand = new Pcg32();
	
	@Override
	public void generate(Room room) {
		int chestX = rand.nextInt(room.getWidth() - 2) + room.getX() + 1;
		int chestY = rand.nextInt(room.getHeight() - 2) + room.getY() + 1;
		
		EntityChest chest = new EntityChest(room.getLevel().getDungeon(), room.getLevel(), chestX, chestY);
		populateChest(room, chest);
		room.getLevel().getEntityStore().addEntity(chest);
	}
	
	private void populateChest(Room room, EntityChest chest) {
		if (!chest.getContainer().isPresent()) {
			return;
		}
		
		Container container = chest.getContainer().get();
		
		int itemAmount = RandomUtils.roll(4) - 1;</span><span class='comment'> // possibility that chests can be empty
</span><span class='code'>		
		for (int i = 0; i &lt; itemAmount; i++) {
			ItemGroup group = ITEM_GROUPS.next();
			Class&lt;? extends Item> itemClass = group.getRandomItem();
			
			populateChestItem(room, chest, container, itemClass);
		}
	}
	
	private void populateChestItem(Room room, EntityChest chest, Container container, Class&lt;? extends Item> itemClass) {
		Constructor&lt;? extends Item> constructor = ConstructorUtils.getAccessibleConstructor(itemClass, Level.class);
		Item item;
		
		if (constructor != null) {
			try {
				item = constructor.newInstance(room.getLevel());
			} catch (InstantiationException | IllegalAccessException | InvocationTargetException e) {
				JRogue.getLogger().error("Error adding chest items", e);
				return;
			}
		} else {
			constructor = ConstructorUtils.getAccessibleConstructor(itemClass);
			
			try {
				item = constructor.newInstance();
			} catch (InstantiationException | IllegalAccessException | InvocationTargetException e) {
				JRogue.getLogger().error("Error adding chest items", e);
				return;
			}
		}
		
		if (item instanceof SpecialChestSpawn) {
			((SpecialChestSpawn) item).onSpawnInChest(chest, container);
		} else {
			ItemStack stack = new ItemStack(item, 1);
			container.add(stack);
		}
	}
		
	protected static class ItemGroup {
		private List&lt;Class&lt;? extends Item>> items = new ArrayList&lt;>();
		
		@SafeVarargs
		private ItemGroup(Class&lt;? extends Item>... items) {
			this.items.addAll(Arrays.asList(items));
		}
		
		public Class&lt;? extends Item> getRandomItem() {
			return RandomUtils.randomFrom(items);
		}
	}
}
</span>
</PRE></CODE>
</BODY>
</HTML>
