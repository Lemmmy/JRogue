<HTML>
<HEAD>
<TITLE>JDocCoverage Report - 14-Mar-2017 09:54:02</TITLE>
<link rel='stylesheet' type='text/css' href='default.css'>
</HEAD>
<BODY>
<TABLE cellspacing='0' class='header'><TR><TD class='title'>JDocCoverage Report - 14-Mar-2017 09:54:02</TD></TR>
<TR><TD class='menu'><a class='menu' href='index.html'>Overview</a> | <a class='menu' href='jr.dungeon.entities.player.visitors.html'>jr.dungeon.entities.player.visitors</a></TD></TR></TABLE>
<p>
<TABLE cellspacing='0'>
<TR><TH>Name</TH><TH>method, %</TH><TH>comment, %</TH><TH>TODO</TH><TH>@see</TH></TR>

<TR><TD>jr.dungeon.entities.player.visitors.PlayerWalk</TD><TD>2</TD><TD>8.3% &nbsp; (145/1594)</TD><TD>0</TD><TD>0</TD></TR>
</TABLE>
<CODE><PRE>
<span class='code'>package jr.dungeon.entities.player.visitors;

import jr.dungeon.entities.Entity;
import jr.dungeon.entities.EntityLiving;
import jr.dungeon.entities.actions.ActionMove;
import jr.dungeon.entities.actions.Action;
import jr.dungeon.entities.player.Player;
import jr.dungeon.entities.player.events.PlayerWalkedIntoSolidEvent;
import jr.dungeon.items.weapons.ItemWeaponMelee;
import jr.dungeon.tiles.Tile;
import jr.dungeon.tiles.TileType;
import lombok.AllArgsConstructor;

import java.util.List;
import java.util.Optional;

@AllArgsConstructor
public class PlayerWalk implements PlayerVisitor {
	private int dx, dy;
	
	@Override
	public void visit(Player player) {
		dx = Math.max(-1, Math.min(1, dx));
		dy = Math.max(-1, Math.min(1, dy));
		
		int newX = player.getX() + dx;
		int newY = player.getY() + dy;
		
		Tile tile = player.getLevel().getTileStore().getTile(newX, newY);
		
		if (tile == null) {
			return;
		}
		
		List&lt;Entity> destEntities = player.getLevel().getEntityStore().getEntitiesAt(newX, newY);
		
		if (destEntities.size() > 0) {
</span><span class='comment'>			// TODO: Ask the player to confirm if they want to attack something silly (e.g. their familiar or a clerk)
</span><span class='code'>			
			Optional&lt;Entity> ent = destEntities.stream()
				.filter(e -> e instanceof EntityLiving)
				.findFirst();
			
			if (ent.isPresent()) {
				if (player.getRightHand() != null && player.getRightHand().getItem() instanceof ItemWeaponMelee) {
					((ItemWeaponMelee) player.getRightHand().getItem()).hit(player, (EntityLiving) ent.get());
				} else if (player.getLeftHand() != null && player.getLeftHand().getItem() instanceof ItemWeaponMelee) {
					((ItemWeaponMelee) player.getLeftHand().getItem()).hit(player, (EntityLiving) ent.get());
				} else {
					player.getDungeon().You("have no weapon equipped!");</span><span class='comment'> // TODO: Make it possible to attack bare-handed
</span><span class='code'>				}
			} else {
				walkAction(player, tile, newX, newY);
			}
		} else {
			walkAction(player, tile, newX, newY);
		}</span><span class='comment'> // TODO: Restructure this mess
</span><span class='code'>		
		player.getDungeon().turn();
	}
	
	private void walkAction(Player player, Tile tile, int x, int y) {
		if (tile.getType().getSolidity() != TileType.Solidity.SOLID) {
			player.setAction(new ActionMove(x, y, new Action.NoCallback()));
		} else {
			player.getDungeon().triggerEvent(new PlayerWalkedIntoSolidEvent(player, tile, x, y, dx, dy));
		}
	}
}
</span>
</PRE></CODE>
</BODY>
</HTML>
